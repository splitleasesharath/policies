<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Connection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2E1A47;
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }
    button {
      background: #4A2B6B;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #2E1A47;
    }
    .policy-item {
      padding: 10px;
      margin: 10px 0;
      background: #f8f9fa;
      border-left: 4px solid #4A2B6B;
      border-radius: 3px;
    }
    .policy-item h3 {
      margin: 0 0 5px 0;
      color: #2E1A47;
    }
    .policy-item p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîå Supabase Connection Test</h1>

    <div id="status"></div>

    <button onclick="testConnection()">Test Connection</button>
    <button onclick="fetchPolicies()">Fetch Policies</button>
    <button onclick="showRawData()">Show Raw Data</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="results"></div>
  </div>

  <!-- Supabase JavaScript Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Supabase Config -->
  <script src="js/supabase-config.js"></script>

  <!-- Test Scripts -->
  <script>
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
    }

    function showResults(html) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = html;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('status').innerHTML = '';
    }

    async function testConnection() {
      showStatus('Testing Supabase connection...', 'info');

      try {
        // Check if supabase client exists
        if (!window.supabaseClient) {
          showStatus('‚ùå ERROR: Supabase client not initialized!', 'error');
          return;
        }

        showStatus('‚úÖ Supabase client is initialized!', 'success');

        // Try a simple query
        const { data, error } = await window.supabaseClient
          .from('zat_policiesdocuments')
          .select('count')
          .limit(1);

        if (error) {
          showStatus(`‚ùå Connection Error: ${error.message}`, 'error');
          showResults(`<pre>${JSON.stringify(error, null, 2)}</pre>`);
        } else {
          showStatus('‚úÖ Successfully connected to Supabase!', 'success');
          showResults(`<p>Connection successful! Database is accessible.</p>`);
        }
      } catch (err) {
        showStatus(`‚ùå Unexpected Error: ${err.message}`, 'error');
        showResults(`<pre>${err.stack}</pre>`);
      }
    }

    async function fetchPolicies() {
      showStatus('Fetching policies from Supabase...', 'info');

      try {
        const { data, error } = await window.supabaseClient
          .from('zat_policiesdocuments')
          .select('*')
          .eq('Active', true)
          .order('Name', { ascending: true });

        if (error) {
          showStatus(`‚ùå Fetch Error: ${error.message}`, 'error');
          showResults(`<pre>${JSON.stringify(error, null, 2)}</pre>`);
          return;
        }

        if (!data || data.length === 0) {
          showStatus('‚ö†Ô∏è No policies found in database', 'error');
          showResults('<p>The query succeeded but returned no results. Check if there are active policies in the database.</p>');
          return;
        }

        showStatus(`‚úÖ Successfully fetched ${data.length} policies!`, 'success');

        // Display policies in a nice format
        let html = '<h2>Policies Found:</h2>';
        data.forEach(policy => {
          html += `
            <div class="policy-item">
              <h3>${policy.Name}</h3>
              <p><strong>Slug:</strong> ${policy.Slug || 'N/A'}</p>
              <p><strong>PDF URL:</strong> <a href="${policy['PDF Version']}" target="_blank">${policy['PDF Version']}</a></p>
              <p><strong>Active:</strong> ${policy.Active ? '‚úÖ' : '‚ùå'}</p>
              <p><strong>Visible on logged out:</strong> ${policy['visible on logged out?'] ? '‚úÖ' : '‚ùå'}</p>
            </div>
          `;
        });

        showResults(html);
      } catch (err) {
        showStatus(`‚ùå Unexpected Error: ${err.message}`, 'error');
        showResults(`<pre>${err.stack}</pre>`);
      }
    }

    async function showRawData() {
      showStatus('Fetching raw data...', 'info');

      try {
        const { data, error } = await window.supabaseClient
          .from('zat_policiesdocuments')
          .select('*')
          .eq('Active', true)
          .order('Name', { ascending: true });

        if (error) {
          showStatus(`‚ùå Error: ${error.message}`, 'error');
          showResults(`<pre>${JSON.stringify(error, null, 2)}</pre>`);
          return;
        }

        showStatus(`‚úÖ Fetched ${data.length} records`, 'success');
        showResults(`<h2>Raw JSON Data:</h2><pre>${JSON.stringify(data, null, 2)}</pre>`);
      } catch (err) {
        showStatus(`‚ùå Error: ${err.message}`, 'error');
        showResults(`<pre>${err.stack}</pre>`);
      }
    }

    // Auto-run test on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Test page loaded');
      console.log('Supabase client:', window.supabaseClient);
      testConnection();
    });
  </script>
</body>
</html>
